<?php

use database\Collaborator;
use database\CollaboratorFingerPrint;
use database\Session;
use database\Notifier;

$uri = basename($_SERVER['REQUEST_URI']);
// $page = substr($uri, 0, strrpos($uri,"?"));

$GLOBALS['authorized_id_entidade'] = 0;
$GLOBALS['authorized_nome'] = '';
$GLOBALS['authorized'] = false;

if (!isset($GLOBALS['authorized_skip'])) {

    $GLOBALS['authorized_skip'] = false;
}

$header_authorization = apache_request_headers();

if (key_exists("Authorization", $header_authorization) && $header_authorization["Authorization"] != "null") {

    $token = explode(" ", $header_authorization["Authorization"])[1];

    $token = explode(".", $token);

    $header = $token[0];
    $payload = $token[1];
    $signature = $token[2];

    $valid = hash_hmac('sha256', "$header.$payload", 'minha-senha', true);
    $valid = base64_encode($valid);

    if ($signature == $valid) {

        $payload = base64_decode($payload);
        $GLOBALS['authorized_payload'] = json_decode($payload);

        $collaborator = new Collaborator();

        if ($collaborator->Read($GLOBALS['authorized_payload']->id)) {

            if ($row = $collaborator->getResult()) {

                if (key_exists("api_access", $GLOBALS) || $row['sessao'] == $GLOBALS['authorized_payload']->session) {

                    $fingerprint = new CollaboratorFingerPrint();

                    $fingerprint->FingerPrint($row['id_entidade'], $uri);

                    $GLOBALS['authorized_id_entidade'] = $row['id_entidade'];
                    $GLOBALS['authorized_nome'] = $row['nome'];
                    $GLOBALS['authorized'] = true;
                }
            }
        }
    }
}

if (!$GLOBALS['authorized_skip'] && !$GLOBALS['authorized']) {

    switch($uri) {

        case "backend.php":
        case "waiter.php":
        case "index.php":
        case "cgi.php":
        case "":

            Session::set('page', null);

            break;

        default:

            Session::set('page', $uri);

            break;
    }

    header('HTTP/1.1 410 GONE');
    exit();
}